generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Profile {
  id        String   @id @db.Uuid
  fullName  String?  @map("full_name")
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  ownedGroups     Group[]        @relation("GroupOwner")
  memberships     GroupMember[]
  paidExpenses    Expense[]
  expenseSplits   ExpenseSplit[]
  settlementsFrom Settlement[]   @relation("SettlementFrom")
  settlementsTo   Settlement[]   @relation("SettlementTo")

  @@map("profiles")
}

model Group {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId     String   @map("owner_id") @db.Uuid
  name        String
  description String?
  currency    String   @default("USD")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  owner       Profile       @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  expenses    Expense[]
  settlements Settlement[]

  @@map("groups")
}

model GroupMember {
  groupId  String   @map("group_id") @db.Uuid
  memberId String   @map("member_id") @db.Uuid
  role     String   @default("member")
  joinedAt DateTime @default(now()) @map("joined_at") @db.Timestamptz(6)

  group  Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  member Profile @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([groupId, memberId])
  @@map("group_members")
}

model Expense {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId     String   @map("group_id") @db.Uuid
  payerId     String   @map("payer_id") @db.Uuid
  description String
  amount      Decimal  @db.Decimal(12, 2)
  expenseDate DateTime @map("expense_date") @db.Date
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  group  Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  payer  Profile        @relation(fields: [payerId], references: [id], onDelete: SetNull)
  splits ExpenseSplit[]

  @@map("expenses")
}

model ExpenseSplit {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expenseId String  @map("expense_id") @db.Uuid
  memberId  String  @map("member_id") @db.Uuid
  share     Decimal @db.Decimal(12, 2)

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  member  Profile @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("expense_splits")
}

model Settlement {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId        String   @map("group_id") @db.Uuid
  fromMember     String   @map("from_member") @db.Uuid
  toMember       String   @map("to_member") @db.Uuid
  amount         Decimal  @db.Decimal(12, 2)
  settlementDate DateTime @map("settlement_date") @db.Date
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  group Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  from  Profile @relation("SettlementFrom", fields: [fromMember], references: [id], onDelete: Cascade)
  to    Profile @relation("SettlementTo", fields: [toMember], references: [id], onDelete: Cascade)

  @@map("settlements")
}
